---
id: auto-instrument-config
title: 설정 옵션
description: Go 라이브러리를 이용해 와탭 에이전트에 모니터링할 데이터를 전송할 수 있습니다.
keywords: [ Go, API 가이드, 라이브러리 ]
---

whatap-go-inst 설정 파일에 대한 상세 가이드입니다.

## 목차

- [설정 파일 위치](#설정-파일-위치)
- [설정 파일 형식](#설정-파일-형식)
- [Preset 옵션](#preset-옵션)
- [패키지 목록](#패키지-목록)
- [제외 패턴](#제외-패턴)
- [우선순위](#우선순위)
- [사용 예시](#사용-예시)
- [환경 변수](#환경-변수)
- [로그 수집 설정](#로그-수집-설정)

---

## 설정 파일 위치

설정 파일은 다음 순서로 검색됩니다:

| 순서 | 위치 | 설명 |
|------|------|------|
| 1 | `--config` 플래그 | CLI에서 명시적으로 지정 |
| 2 | `WHATAP_INST_CONFIG` 환경변수 | 환경변수로 지정 |
| 3 | `.whatap/config.yaml` | **기본 권장 위치** |
| 4 | `.whatap/whatap.yaml` | 대체 설정 파일 |

> **권장**: `.whatap/config.yaml` 경로에 설정 파일을 생성하세요.

---

## 설정 파일 형식

### 전체 구조

```yaml
# .whatap/config.yaml

instrumentation:
  # 기본 옵션
  error_tracking: false    # 에러 추적 코드 삽입 (--error-tracking)
  debug: false             # 디버그 출력 활성화 (GO_API_AST_DEBUG)
  output_dir: ""           # 계측된 소스 출력 디렉토리

  # 패키지 선택
  preset: "full"           # 계측 프리셋 (full/minimal/web/database/external/log/custom)
  enabled_packages: []     # 추가로 활성화할 패키지
  disabled_packages: []    # 비활성화할 패키지

# 사용자 정의 계측 (별도 문서 참조: auto-instrument-custom.md)
custom:
  inject: []      # 함수 정의 내부에 코드 삽입
  replace: []     # 함수 호출 교체
  hook: []        # 함수 호출 전후에 코드 삽입
  transform: []   # 코드 패턴 -> 템플릿 변환

# 제외할 파일 패턴 (선택 - 생략 시 기본값 자동 적용)
# exclude:
#   - "*_test.go"
#   - "vendor/**"
```

### instrumentation 섹션

| 필드 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `error_tracking` | bool | `false` | `if err != nil` 패턴에 `trace.Error()` 자동 삽입 |
| `debug` | bool | `false` | 디버그 로그 출력 (`GO_API_AST_DEBUG=1`과 동일) |
| `output_dir` | string | `""` | 계측된 소스 출력 디렉토리 |
| `preset` | string | `"full"` | 계측 프리셋 선택 |
| `enabled_packages` | []string | `[]` | 추가로 활성화할 패키지 |
| `disabled_packages` | []string | `[]` | 비활성화할 패키지 |

---

## Preset 옵션

계측할 패키지 그룹을 선택합니다.

| Preset | 설명 | 포함 패키지 |
|--------|------|-------------|
| `full` | 모든 패키지 활성화 **(기본값)** | Web + DB + External + Log |
| `minimal` | trace.Init/Shutdown만 추가 | 없음 (main 초기화만) |
| `web` | 웹 프레임워크만 | gin, echo, fiber, chi, gorilla, nethttp, fasthttp |
| `database` | 데이터베이스만 | sql, sqlx, gorm, jinzhugorm |
| `external` | 외부 서비스만 | redigo, goredis, mongo, aerospike, sarama, grpc, k8s |
| `log` | 로깅 라이브러리만 | fmt, log, logrus, zap |
| `custom` | 사용자 정의 | enabled_packages로 지정 |

### Preset 동작 방식

```
최종 활성화 패키지 = Preset 패키지 + enabled_packages - disabled_packages
```

- `preset: full` + `disabled_packages: ["grpc"]` → gRPC 제외 전체
- `preset: web` + `enabled_packages: ["sql"]` → 웹 + SQL
- `preset: custom` + `enabled_packages: ["gin", "sql"]` → Gin과 SQL만

---

## 패키지 목록

### 웹 프레임워크 (`web`)

| 패키지명 | 라이브러리 | 삽입 코드 |
|----------|----------|-----------|
| `gin` | github.com/gin-gonic/gin | `whatapgin.Middleware()` |
| `echo` | github.com/labstack/echo/v4 | `whatapecho.Middleware()` |
| `fiber` | github.com/gofiber/fiber/v2 | `whatapfiber.Middleware()` |
| `chi` | github.com/go-chi/chi/v5 | `whatapchi.Middleware` |
| `gorilla` | github.com/gorilla/mux | `whatapmux.Middleware` |
| `nethttp` | net/http | `whataphttp.Func()`, `whataphttp.Handler()` |
| `fasthttp` | github.com/valyala/fasthttp | `whatapfasthttp.Middleware()` |

### 데이터베이스 (`database`)

| 패키지명 | 라이브러리 | 삽입 코드 |
|----------|----------|-----------|
| `sql` | database/sql | `whatapsql.Open()` |
| `sqlx` | github.com/jmoiron/sqlx | `whatapsqlx.Open()` |
| `gorm` | gorm.io/gorm | `whatapgorm.Open()` |
| `jinzhugorm` | github.com/jinzhu/gorm | `whatapgorm.Open()` |

### 외부 서비스 (`external`)

| 패키지명 | 라이브러리 | 삽입 코드 |
|----------|----------|-----------|
| `redigo` | github.com/gomodule/redigo | `whatapredigo.Dial()` |
| `goredis` | github.com/redis/go-redis/v9 | `whatapgoredis.NewClient()` |
| `mongo` | go.mongodb.org/mongo-driver | `whatapmongo.Connect()` |
| `aerospike` | github.com/aerospike/aerospike-client-go | `whatapsql.Wrap()` |
| `sarama` | github.com/IBM/sarama | Interceptor 삽입 |
| `grpc` | google.golang.org/grpc | Server/Client Interceptor |
| `k8s` | k8s.io/client-go | `config.Wrap()` |

### 로깅 라이브러리 (`log`)

| 패키지명 | 라이브러리 | 삽입 코드 |
|----------|----------|-----------|
| `fmt` | fmt | `whatapfmt.Print/Printf/Println()` |
| `log` | log | `log.SetOutput(logsink.GetTraceLogWriter())` |
| `logrus` | github.com/sirupsen/logrus | `logrus.SetOutput(logsink.GetTraceLogWriter())` |
| `zap` | go.uber.org/zap | `logsink.HookStderr()` |

---

## 제외 패턴

계측에서 제외할 파일 패턴을 지정합니다.

### 기본 제외 패턴

설정 파일에 `exclude` 패턴을 지정하지 않으면 다음 패턴이 **자동으로 적용**됩니다:

```
**/*.pb.go           # protobuf 생성 파일
**/*.pb.gw.go        # grpc-gateway 생성 파일
**/*_grpc.pb.go      # grpc 생성 파일
**/*.connect.go      # connect-go 생성 파일
**/*_generated.go    # 자동 생성 파일
**/*_gen.go          # 코드 생성기 출력
**/*_test.go         # 테스트 파일
vendor/**            # vendor 디렉토리
.git/**              # git 디렉토리
node_modules/**      # node_modules 디렉토리
whatap-instrumented/**  # 계측된 출력 디렉토리
```

이 패턴들은 다음을 방지합니다:
- **생성된 코드** (protobuf, grpc-gateway 등) - 컴파일 오류 발생 가능
- **테스트 파일** - 프로덕션 모니터링에 불필요
- **의존성 디렉토리** (vendor, node_modules) - 서드파티 코드

### 사용자 정의 제외 패턴

`exclude` 패턴을 지정하면 기본값을 **대체**합니다:

```yaml
# .whatap/config.yaml
exclude:
  - "*_test.go"
  - "vendor/**"
  - "internal/legacy/**"    # 커스텀: 레거시 코드 제외
```

### Glob 패턴 문법

| 패턴 | 설명 | 매칭 예시 |
|------|------|-----------|
| `*` | 파일명의 모든 문자 | `*.go` → `main.go` |
| `**` | 재귀적으로 모든 디렉토리 | `**/test/**` → `a/b/test/c/d.go` |
| `?` | 단일 문자 | `test?.go` → `test1.go` |
| `[abc]` | 문자 클래스 | `test[12].go` → `test1.go` |

### 예시

#### 예시 1: 특정 디렉토리 제외

```yaml
exclude:
  - "**/*.pb.go"
  - "**/*_test.go"
  - "migrations/**"      # 데이터베이스 마이그레이션 제외
```

#### 예시 2: 생성된 파일만 제외

```yaml
exclude:
  - "**/*.pb.go"
  - "**/*.pb.gw.go"
  - "**/*_generated.go"
```

> **참고**: 시스템 경로 (`GOROOT`, `GOMODCACHE`)는 설정과 관계없이 항상 제외됩니다.

---

## 우선순위

설정값 우선순위:

```
CLI 옵션 > 환경 변수 > 설정 파일 > 기본값
```

| 출처 | 예시 | 우선순위 |
|------|------|----------|
| CLI 옵션 | `--error-tracking` | 1 (최고) |
| 환경 변수 | `GO_API_AST_DEBUG=1` | 2 |
| 설정 파일 | `error_tracking: true` | 3 |
| 기본값 | `false` | 4 |

> 설정 파일에서 `error_tracking: true`로 설정해도 CLI에서 `--error-tracking=false`를 지정하면 CLI 값이 우선합니다.

---

## 사용 예시

### 기본 사용

```bash
# .whatap/config.yaml 자동 로드
whatap-go-inst go build ./...

# 설정 파일 명시적 지정
whatap-go-inst --config ./my-config.yaml go build ./...
```

### 예시 1: minimal - trace만

```yaml
# .whatap/config.yaml
instrumentation:
  preset: "minimal"
```

결과:
- `trace.Init(nil)`, `defer trace.Shutdown()` 추가
- 프레임워크 미들웨어 추가 안 됨

### 예시 2: 웹과 DB만 계측

```yaml
instrumentation:
  preset: "custom"
  enabled_packages:
    - "gin"
    - "echo"
    - "sql"
    - "gorm"
```

### 예시 3: full에서 특정 패키지 제외

```yaml
instrumentation:
  preset: "full"
  disabled_packages:
    - "k8s"
    - "grpc"
    - "aerospike"
```

### 예시 4: 에러 추적 활성화

```yaml
instrumentation:
  error_tracking: true
  preset: "web"
```

결과: `if err != nil` 패턴에 `trace.Error(err)` 자동 삽입

### 예시 5: 디버그 모드

```yaml
instrumentation:
  debug: true
  preset: "full"
```

출력 예시:
```
[whatap-go-inst] Config file: .whatap/config.yaml
[whatap-go-inst] ErrorTracking: false
```

---

## 환경 변수

| 변수 | 설명 | 예시 |
|------|------|------|
| `GO_API_AST_DEBUG` | 디버그 출력 활성화 | `GO_API_AST_DEBUG=1` |
| `GO_API_AST_OUTPUT_DIR` | 계측된 소스 출력 디렉토리 | `GO_API_AST_OUTPUT_DIR=./out` |
| `WHATAP_INST_CONFIG` | 설정 파일 경로 | `WHATAP_INST_CONFIG=./config.yaml` |

### 환경 변수 사용 예시

```bash
# 디버그 모드로 빌드
GO_API_AST_DEBUG=1 whatap-go-inst go build ./...

# 설정 파일 지정
WHATAP_INST_CONFIG=./prod-config.yaml whatap-go-inst go build ./...
```

---

## 로그 수집 설정

> **참고**: 로그 수집은 whatap-go-inst AST 계측과 whatap.conf 런타임 설정 두 가지 모두 동작합니다.

### AST 계측 (whatap-go-inst)

로깅 라이브러리 계측은 `log` 프리셋에 포함됩니다.

```yaml
# .whatap/config.yaml
instrumentation:
  preset: "full"     # log 포함
  # 또는
  preset: "log"      # 로그만
```

계측 후 삽입되는 코드:

| 라이브러리 | 삽입 코드 |
|------------|-----------|
| 표준 log | `log.SetOutput(logsink.GetTraceLogWriter(os.Stderr))` |
| logrus | `logrus.SetOutput(logsink.GetTraceLogWriter(os.Stderr))` |
| zap | `logsink.HookStderr()` |

### 런타임 설정 (whatap.conf)

whatap.conf에서 로그 수집 방식을 설정합니다.

#### 기본값과 권장 설정

go-api 기본값은 TraceLogWriter를 권장합니다.

| 설정 | 기본값 | 설명 |
|------|--------|------|
| `logsink_enabled` | `false` | 전체 로그 수집 on/off |
| `logsink_trace_enabled` | **`true`** | TraceLogWriter (권장) |
| `logsink_stdout_enabled` | `false` | ProxyStream stdout (레거시) |
| `logsink_stderr_enabled` | `false` | ProxyStream stderr (레거시) |
| `logsink_fmt_enabled` | `false` | whatapfmt (검토 중) |

```ini
# whatap.conf - logsink_enabled만 켜면 TraceLogWriter 자동 사용
logsink_enabled=true
```

#### 로그 수집 방식 비교

| 방식 | 설정 | 트랜잭션 연계 | 권장 |
|------|------|--------------|------|
| **TraceLogWriter** | `logsink_trace_enabled=true` | txid/mtid/gid 포함 | **권장** |
| ProxyStream (stdout) | `logsink_stdout_enabled=true` | 연계 불가 | 레거시 |
| ProxyStream (stderr) | `logsink_stderr_enabled=true` | 연계 불가 | 레거시 |

#### TraceLogWriter 권장 이유

| 항목 | TraceLogWriter | ProxyStream |
|------|----------------|-------------|
| **트랜잭션 연계** | 로그에 @txid, @mtid, @gid 포함 | 트랜잭션 추적 불가 |
| **성능** | pipe 오버헤드 없음 | pipe goroutine 필요 |
| **WhaTap 대시보드** | 트랜잭션 → 로그 연결 가능 | 별도 로그만 표시 |

> **참고**: whatap-go-inst로 계측하면 TraceLogWriter가 자동 삽입됩니다. ProxyStream은 더 이상 필요하지 않으므로 비활성화를 권장합니다.

### 로그 수집 설정 예시

#### 예시 1: 권장 설정 (전체 활성화)

```yaml
# .whatap/config.yaml
instrumentation:
  preset: "full"
```

```ini
# whatap.conf
logsink_enabled=true
logsink_trace_enabled=true
logsink_stdout_enabled=false
logsink_stderr_enabled=false
```

#### 예시 2: 로그 계측 제외

로그 수집이 필요 없는 경우:

```yaml
# .whatap/config.yaml
instrumentation:
  preset: "full"
  disabled_packages:
    - "log"
    - "logrus"
    - "zap"
```

```ini
# whatap.conf
logsink_enabled=false
```

---

## 관련 문서

- [시작하기](auto-instrument-guide.md) - 빠른 시작 가이드
- [사용자 정의 계측](auto-instrument-custom.md) - add, inject, replace, hook, transform
- [멀티 모듈 프로젝트](auto-instrument-multi-module.md) - 멀티 모듈 가이드
- [API 가이드](api-guide.md) - go-api 직접 사용 방법