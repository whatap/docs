---
id: auto-instrument-troubleshooting
title: 트러블슈팅
description: whatap-go-inst 사용 시 발생할 수 있는 문제와 해결 방법을 안내합니다.
keywords: [ Go, whatap-go-inst, 트러블슈팅, 제한사항 ]
---

whatap-go-inst 사용 시 발생할 수 있는 문제와 해결 방법을 안내합니다.

## 제한사항

### 지원되지 않는 코드 패턴

다음 패턴은 whatap-go-inst 코드 삽입이 적용되지 않습니다. 코드 패턴을 변경하거나 [사용자 정의 계측](auto-instrument-custom.mdx)을 사용하세요.

#### 1. dot import 사용
```go
// ❌ 미들웨어 자동 추가 안 됨
import . "github.com/gin-gonic/gin"

func main() {
    r := Default()  // gin.Default()가 아니므로 감지 불가
}
```

**해결 방법:** 일반 import 사용
```go
// ✅ 정상 동작
import "github.com/gin-gonic/gin"

func main() {
    r := gin.Default()  // 감지됨
}
```

---

#### 2. 전역 변수에서 라우터 초기화
```go
// ❌ 미들웨어 자동 추가 안 됨
var Router = gin.Default()  // 전역 레벨 초기화
```

**해결 방법:** main() 또는 init() 함수 내에서 초기화
```go
// ✅ 정상 동작
var Router *gin.Engine

func main() {
    Router = gin.Default()  // 함수 내 초기화
}
```

또는
```go
// ✅ 정상 동작
var Router *gin.Engine

func init() {
    Router = gin.Default()  // init 함수 내 초기화
}
```

---

#### 3. 별칭(Alias)을 사용한 import
```go
// ❌ 감지 안 됨
import mygorm "gorm.io/gorm"

db, _ := mygorm.Open(...)  // whatapgorm.Open으로 변환되지 않음
```

**해결 방법 1:** 표준 import 사용
```go
// ✅ 해결 방법 1: 표준 import
import "gorm.io/gorm"

db, _ := gorm.Open(...)  // 자동 변환됨
```

**해결 방법 2:** 수동으로 래핑
```go
// ✅ 해결 방법 2: 수동 추가
import (
    mygorm "gorm.io/gorm"
    "github.com/whatap/go-api/instrumentation/database/whatapgorm"
)

db, _ := whatapgorm.Open(...)
```

---

## 계측이 적용되지 않을 때

### 1단계: 빌드 캐시 삭제
```bash
# 빌드 캐시 삭제
go clean -cache

# 재빌드
whatap-go-inst go build ./...
```

### 2단계: 디버그 모드 확인
```bash
# 디버그 출력으로 계측 과정 확인
GO_API_AST_DEBUG=1 whatap-go-inst go build ./...
```

**확인 사항:**
- `whatap-go-inst init` 실행 여부
- 변환된 파일 목록
- 적용된 transformer

**정상 출력 예시:**
```
[whatap-go-inst] Config file: .whatap/config.yaml
[whatap-go-inst] Preset: full
[whatap-go-inst] Processing: main.go
[whatap-go-inst]   Added: trace.Init
[whatap-go-inst]   Added: trace.Shutdown
[whatap-go-inst] Processing: handler.go
[whatap-go-inst]   Transformed: gin.Default -> added middleware
```

### 3단계: 초기화 확인
```bash
# whatap_inst.tool.go 파일 확인
ls -la whatap_inst.tool.go

# go.mod에 whatap 의존성 확인
grep whatap go.mod
```

**없는 경우:**
```bash
# 초기화 다시 실행
whatap-go-inst init
```

### 4단계: 계측된 코드 확인
```bash
# 계측된 코드를 별도 디렉토리에 출력
GO_API_AST_OUTPUT_DIR=./instrumented whatap-go-inst go build ./...

# 파일 비교
diff main.go ./instrumented/main.go
```

### 5단계: 제한사항 확인

[제한사항](#제한사항) 섹션의 패턴에 해당하는지 확인하세요.

---

## 일반적인 문제 해결

### 컴파일 에러: whatap 패키지를 찾을 수 없음

**증상:**
```
cannot find package "github.com/whatap/go-api/trace"
```

**해결 방법:**
```bash
# 방법 1: init 실행 (자동 해결)
whatap-go-inst init
whatap-go-inst go build ./...

# 방법 2: 수동 설치
go get github.com/whatap/go-api@latest
go mod tidy
```

---

### 특정 파일만 계측되지 않음

**원인:**
- 파일이 제외 패턴에 포함됨
- 생성된 코드 파일 (`*.pb.go`, `*_generated.go` 등)

**확인 방법:**
```bash
# 스킵된 파일 확인
GO_API_AST_DEBUG=1 whatap-go-inst go build ./... 2>&1 | grep "SKIP"
```

**해결 방법:**

제외 패턴을 조정하거나 특정 파일 제외를 해제합니다. 자세한 내용은 [설정 가이드 - 제외 패턴](auto-instrument-config.md#파일-제외-패턴)을 참고하세요.

---

### 빌드는 성공하지만 데이터가 보이지 않음

#### 1. 에이전트 실행 확인
```bash
ps -ef | grep whatap_agent
```

**없는 경우:**
```bash
# 에이전트 시작
/usr/whatap/agent/whatap_agent -d
```

#### 2. main() 초기화 확인
```bash
# main() 함수에 trace.Init이 있는지 확인
GO_API_AST_DEBUG=1 whatap-go-inst go build ./... 2>&1 | grep "trace.Init"
```

#### 3. whatap.conf 설정 확인
```bash
cat /usr/whatap/agent/whatap.conf
```

**필수 설정:**
```ini
license={액세스 키}
whatap.server.host={수집 서버 IP}
```

---

### Docker 환경에서 계측 안 됨

**문제:** 멀티스테이지 빌드에서 whatap-go-inst가 설치되지 않음

**해결 방법:**
```dockerfile
FROM golang:1.21 AS builder

# whatap-go-inst 설치
RUN go install github.com/whatap/go-api-inst/cmd/whatap-go-inst@latest

# 초기화 및 빌드
COPY . .
RUN whatap-go-inst init
RUN whatap-go-inst go build -o /app/myapp .
```

자세한 내용은 [Docker 설치 가이드](install-agent-docker.mdx)를 참고하세요.

---

## 실행 모드 비교

whatap-go-inst는 여러 실행 모드를 제공합니다. 상황에 맞는 모드를 선택하세요.

### 모드 비교표

| 모드 | 명령어 | 원본 변경 | 의존성 자동 | 권장 용도 |
|------|--------|----------|------------|----------|
| **빌드 래퍼** | `whatap-go-inst go build` | tool.go만 | ✅ | **일반 사용** (권장) |
| **wrap 모드** | `whatap-go-inst go --wrap build` | ❌ | ✅ | 테스트/임시 적용 |
| **inject 모드** | `whatap-go-inst inject` | 별도 출력 | ❌ | 코드 검토/CI |

### 빌드 래퍼 (권장)
```bash
# 1. 초기화 (최초 1회)
whatap-go-inst init

# 2. 빌드
whatap-go-inst go build ./...
```

**특징:**
- ✅ `whatap_inst.tool.go` 파일 1개 추가
- ✅ go.mod에 의존성 자동 추가
- ✅ 일반 사용에 권장

---

### wrap 모드
```bash
# init 없이 바로 빌드
whatap-go-inst go --wrap build ./...
```

**특징:**
- ✅ 원본 파일 전혀 변경 안 됨
- ✅ init 불필요
- ✅ 첫 테스트나 임시 적용에 유용
- ⚠️ 매번 `--wrap` 옵션 필요

**사용 사례:**
- 프로덕션 적용 전 테스트
- 임시로 모니터링 활성화
- CI/CD에서 선택적 계측

---

### inject 모드
```bash
# 계측된 코드를 별도 디렉토리에 출력
whatap-go-inst inject -s ./src -o ./instrumented

# 출력된 코드로 빌드
cd instrumented
go build ./...
```

**특징:**
- ✅ 계측된 코드를 별도로 저장
- ✅ 원본과 계측 코드 비교 가능
- ⚠️ 의존성 수동 설치 필요
- ⚠️ 빌드 전 inject 실행 필요

**사용 사례:**
- 계측 결과 검토
- CI/CD 파이프라인에서 사전 계측
- 원본과 변환 코드 diff 확인

---

## go-api에서 전환하기

기존에 go-api를 직접 사용한 프로젝트를 whatap-go-inst로 전환하는 방법입니다.

### 1단계: 기존 whatap 코드 제거
```bash
# 자동 삽입 패턴만 제거
whatap-go-inst remove -s . -o ./cleaned

# 수동 삽입 패턴도 제거 시도
whatap-go-inst remove --all -s . -o ./cleaned
```

### 2단계: 변경 사항 확인
```bash
# diff로 차이 확인
diff -r . ./cleaned

# 또는 git diff
cp -r ./cleaned/* .
git diff
```

### 3단계: 커스텀 코드 복원

`remove --all`로 제거되지 않은 패턴이나 필요한 커스텀 코드를 수동으로 복원합니다.
```go
// 예: 커스텀 트랜잭션 코드는 유지
ctx, _ := trace.Start(context.Background(), "CustomTx")
defer trace.End(ctx, nil)
```

### 4단계: whatap-go-inst로 빌드
```bash
whatap-go-inst init
whatap-go-inst go build ./...
```

:::caution 주의

**자동 제거되지 않는 패턴:**
- 변수 할당: `ctx := trace.Start(...)`
- 클로저 패턴: `whatapsql.Wrap(...)`
- 복잡한 커스텀 계측

이런 패턴은 경고 메시지가 출력되며 수동으로 제거해야 합니다.

:::

### 전환 체크리스트

- [ ] 기존 whatap 코드 제거
- [ ] 변경 사항 diff 확인
- [ ] 커스텀 코드 복원 확인
- [ ] whatap-go-inst init 실행
- [ ] 빌드 성공 확인
- [ ] 로컬에서 모니터링 데이터 확인
- [ ] 테스트 환경 배포 및 확인
- [ ] 프로덕션 배포

---

## 추가 지원

위 방법으로 해결되지 않는 경우:

1. **디버그 로그 수집**
```bash
   GO_API_AST_DEBUG=1 whatap-go-inst go build ./... > debug.log 2>&1
```

2. **환경 정보 수집**
```bash
   go version
   whatap-go-inst version
   cat .whatap/config.yaml
```

3. **[WhaTap 지원 센터](https://www.whatap.io/ko/support/)** 문의
   - 디버그 로그
   - 환경 정보
   - 재현 가능한 최소 예제

:::tip 여전히 해결되지 않나요?

기본 계측으로 처리할 수 없는 경우 [사용자 정의 계측](auto-instrument-custom.mdx)을 참고하세요.

:::

---

## 관련 문서

- [기본 사용법](auto-instrument.mdx) - whatap-go-inst 시작하기
- [설정 가이드](auto-instrument-config.mdx) - Preset, 환경 변수, 설정 파일
- [사용자 정의 계측](auto-instrument-custom.mdx) - 고급 커스터마이징
- [멀티 모듈 가이드](auto-instrument-multi-module.mdx) - 멀티 모듈 프로젝트