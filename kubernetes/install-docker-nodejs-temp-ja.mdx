---
id: install-docker-nodejs-temp-ja
title: Docker Node.jsインストール
description: コンテナ内のNode.jsアプリケーションをモニタリングするためのエージェントのインストール手順です。
tags:
  - Kubernetes
  - Kubernetesモニタリング
  - アプリケーションインストール
  - Node.js
draft: false
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

***管理*** > ***エージェントインストール*** > 下段の***アプリケーションインストール*** クリック > 設置案内の中で ***Docker Node.js*** タブを選択

Dockerコンテナベースで実行するNode.jsアプリケーションに、WhaTapモニタリングエージェントを適用し、コンテナイメージをパッケージングする過程を次のように案内します。 

:::note 

-   EKS Fargateは、対応予定です。 

-   Node.jsアプリケーション連動過程に対する理解を助けるためにGit例示コードを提供します。 [次の文書](https://github.com/whatap/kuber-apm-boilerplate/tree/main/nodejs/express)を参考にしてください。

:::

## エージェントダウンロード

次のコマンドを使用して、WhaTapをインストールします。

```bash
npm install --save whatap
```

アップデートを継続するには、次のコマンドを実行します。

```bash
npm update whatap
```

## エージェント設定

アプリケーションのメインモジュールの最初の行に、次のコードを追加します。

```javascript title='Example' 
const WhatapAgent = require('whatap').NodeAgent;
WhatapAgent.NodeAgent;
```

ECMAScript(ES) を活用する時、次のコードを追加してください。

```javascript
import WhatapAgent from 'whatap';
WhatapAgent.NodeAgent;
```

## コンテナ環境変数

Dockerビルド後、Kubernetes環境内の**コンテナ環境変数**を設定してください。 アプリケーションリリーズ*yaml*ファイルに次の内容を追加してください。 

```yaml
env:
- name: NODE_IP
  valueFrom: {fieldRef: {fieldPath: status.hostIP}}
- name: NODE_NAME
  valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
- name: POD_NAME
  valueFrom: {fieldRef: {fieldPath: metadata.name}}
- name: OKIND
	value: {YOUR_OKIND_NAME}
- name: license
	value: {licenseKey}
- name: whatap_server_host
	value: {proxyServer}
- name: whatap_micro_enabled
	value: "true"
```

次の例を参照してください。

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: #DeploymentName
  labels:
    app: #AppLabel
spec:
  selector:
    matchLabels:
      app: #AppLabel
	replicas: 3
  template:
    metadata:
      labels:
        app: #AppLabel
		spec:
		  containers:
			- name: #ContainerName
        image: nginx
        ports:
        - containerPort: 80
			  env:
		    - name: NODE_IP
	        valueFrom: {fieldRef: {fieldPath: status.hostIP}}
				- name: NODE_NAME
		      valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
		    - name: POD_NAME
		      valueFrom: {fieldRef: {fieldPath: metadata.name}}
				- name: OKIND
          value: #DeploymentName
				- name: license
					value: {licenseKey}
				- name: whatap_server_host
					value: {proxyServer}
				- name: whatap_micro_enabled
					value: "true"
```

:::note

**環境変数の役割**

-   `NODE_IP`: 現在のPodがホストされているノード(Node)のIPアドレスを収集します。

-   `NODE_NAME`: 現在Podが実行中のノードの名前を収集します。

-   `POD_NAME`: 現在のPodの名前を収集します。

-   `OKIND`(選択事項)：Podに該当するアプリケーションをグループ化します。 デプロイメント(Deployment) 名に設定すると、該当するPodを一つにグループ化します。

-   `license`：エージェント認証を確認するためのキーです。

-   `whatap_server_host`：WhaTap収集サーバーのホストIPです。

-   `whatap_micro_enabled`：コンテナとの連動を活性化します。

:::

## エージェントのインストール確認

-   エージェントが正常にインストールされたことを確認するには、***ダッシュボード*** > ***アプリケーションサービスダッシュボード***メニューに移動してください。

-   ダウンロードしたファイルをインストールした後に***ダッシュボード***メニューからエージェントが表示されない場合は、次の事項を確認してください。

    -   コンテナで`ps -ef | grep whatap`コマンドを実行し、エージェントオプションを適用されていることを確認してください。

    -   コンテナの*/whatap/logs*パスの内容を確認してください。