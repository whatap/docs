---
id: install-docker-python-temp-ja
title: Docker Pythonインストール
description: コンテナ内のPythonアプリケーションをモニタリングするためのエージェントのインストール手順です。
tags:
  - Kubernetes
  - Kubernetesモニタリング
  - アプリケーションインストール
  - Python
draft: false
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

***管理*** > ***エージェントインストール*** > 下段の***アプリケーションインストール*** クリック > 設置案内の中で ***Docker Python*** タブを選択

Dockerコンテナベースで実行するPythonアプリケーションに、WhaTapモニタリングエージェントを適用し、コンテナイメージをパッケージングする過程を次のように案内します。 Kubernetesアプリケーションをリリーズするために、ドッカーイメージが必要です。 次の過程を通じてwhatap-pythonパッケージがインストールされているドッカー画像を作成します。

:::note 

-   EKS Fargateは、対応予定です。 

-   Pythonアプリケーション連動過程に対する理解を助けるためにGit例示コードを提供します。 [次の文書](https://github.com/whatap/kuber-apm-boilerplate/tree/main/python/fastapi)を参考にしてください。

:::

## エージェントダウンロード

PythonアプリケーションのDockerイメージをビルドする場合、whatap-pythonパッケージをインストールします。

```docker
RUN pip3 install --upgrade whatap-python
```

次のDockerfileで定義の例を参考にしてください。 

```docker title='python ver 3.10'
# python3.10을 도커환경에 설치합니다.
FROM python:3.10

# 작업 디렉토리를 /app 으로 설정합니다.
WORKDIR /app

# 현재 디렉토리의 모든 파일과 폴더를 컨테이너 내의 /app 디렉토리에 복사합니다.
ADD . /app/

# 파이썬에서는 pip를 이용하여 외부 라이브러리를 설치할 수 있습니다. 
# 와탭 파이썬 에이전트를 도커 이미지 빌드시 설치합니다.
RUN pip3 install --upgrade whatap-python
```

## エージェントの設定及び実行

アプリケーションを実行する前に、Pythonエージェントの作業ディレクトリを設定し、デフォルトの設定ファイルを作成します。 設定ファイル(*entrypoint.sh*)を通じてエージェントに認証情報を伝達し、ログの追跡有無を設定します。

<details>
<summary>設定ファイル(entrypoint.sh)完成例</summary>

```bash title='entrypoint.sh'
#!/bin/bash

# 컨테이너의 작업 디렉터리를 와탭 경로로 설정하세요. 해당 경로에 에이전트 로그 및 설정 파일을 생성합니다.
export WHATAP_HOME=${PWD}

# 권한 오류 발생 시 다음 주석을 제거 후 진행하세요.
#chmod -R 777 $WHATAP_HOME

# 다음은 에이전트 구성에 필수적인 설정 값입니다. 애플리케이션 배포 yaml 파일을 통해 설정합니다.
whatap-setting-config \
--host $whatap_server_host \
--license $license \
--app_name $app_name \
--app_process_name $app_process_name

# 다음 주석은 에이전트 그룹화 및 로그 수집 활성화 등의 추가 설정입니다. 필요한 경우에만 사용하세요.

# 에이전트 그룹화
#echo "okind=$okind" >> whatap.conf

# 로그 수집 활성화
#echo "logsink_enabled=true" >> whatap.conf
#echo "logsink_trace_enabled=true" >> whatap.conf
#echo "trace_logging_enabled=true" >> whatap.conf


# 다음과 같이 whatap-start-agent를 애플리케이션 시작 명령어 앞에 추가해 에이전트를 실행하세요. 
whatap-start-agent uvicorn server:app --host 0.0.0.0 --port 8000
```

</details>

1.  コンテナ作業ディレクトリを`WHATAP_HOME`環境変数に設定してください。 そのパスにエージェントログと設定ファイルを作成します。 

    ```bash
    export WHATAP_HOME=${PWD}
    ```

2.  `WHATAP_HOME`で設定したパスに*whatap.conf*ファイルを作成するように、次のコマンドを実行してください。 `$`で表される変数は、エージェント構成に不可欠な設定値であり、アプリケーションをリリーズする*yaml*ファイルを通じて設定します。

    ```bash
    whatap-setting-config \
    --host $whatap_server_host \
    --license $license \
    --app_name $app_name \
    --app_process_name $app_process_name
    ```

3.  アプリケーション開始コマンドの前に、次のように`whatap-start-agent`を追加してエージェントを実行してください。 

```bash
whatap-start-agent uvicorn server:app --host 0.0.0.0 --port 8000
```

:::caution

アクセス許可の問題が発生する場合、次のように`$WHATAP_HOME`にアクセス許可を付与します。

```bash
echo `sudo chmod -R 777 $WHATAP_HOME`
```

:::

:::note 

-   *yaml*作成例は、次の[コンテナ環境変数の設定](#k8s-env)を参考にしてください。

-   ライセンス(`license`)は、WhaTapのユーザー認証情報です。 **外部に公開してはいけません**。

:::

### スクリプト実行の例

次のDockerfile定義の例を参考にしてください。 *entrypoint.sh*スクリプトを実行する完成した例です。

```docker
FROM python:3.10
WORKDIR /app
ADD . /app/
RUN pip3 install --upgrade whatap-python 

#entrypoint.sh 스크립트을 컨테이너에서 실행할 수 있도록 권한을 부여합니다.
RUN chmod +x ./entrypoint.sh

# 컨테이너 생성시 entrypoint.sh 스크립트를 실행합니다.
CMD ["./entrypoint.sh"]
```

### 追加設定

次の設定は、選択事項として必要な場合に限って使用してください。 設定ファイル(*entrypoint.sh*)に次の追加設定の他にも、ログ及びトランザクション関連の設定が可能です。 その他の追加設定の場合、[次の文書](https://docs.whatap.io/python/set-agent)を参考にしてください。 

-   **エージェントグループ化** 

    ```bash
    echo "okind=$okind" >> whatap.conf
    ```

-   **ログ収集の活性化** 

    ```bash
    echo "logsink_enabled=true" >> whatap.conf
    echo "logsink_trace_enabled=true" >> whatap.conf
    echo "trace_logging_enabled=true" >> whatap.conf
    ```

## コンテナ環境変数の設定{#k8s-env}

Dockerビルド後、Kubernetes環境内の**コンテナ環境変数**を設定してください。 アプリケーションリリーズ*yaml*ファイルに次の内容を追加してください。 

```yaml
	  env:
		- name: license
			value: XXXXXXXXXXXXXX-XXXXXXXXXXXXXX-XXXXXXXXXXXXXX
		- name: whatap_server_host
			value: XXX.XXX.XXX.XXX
		- name: app_name
			value: {YOUR_APP_NAME}
		- name: app_process_name
		  value: {YOUR_PROCESS_NAME}
		- name: okind
			value: {YOUR_GROUP_NAME}
		- name: NODE_IP
		  valueFrom: {fieldRef: {fieldPath: status.hostIP}}
		- name: NODE_NAME
		  valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
		- name: POD_NAME
		  valueFrom: {fieldRef: {fieldPath: metadata.name}}
```

次の例を参照してください。 

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: python-fastapi-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: python-fastapi-pod
  template:
    metadata:
      labels:
        app: python-fastapi-pod
  containers:
	- name: agent-python-fastapi
    image: whatap/agent-python-fastapi
	  env:
		- name: license
			value: XXXXXXXXXXXXXX-XXXXXXXXXXXXXX-XXXXXXXXXXXXXX
		- name: whatap_server_host
			value: XXX.XXX.XXX.XXX
		- name: app_name
			value: "myapp-python-fastapi"
		- name: app_process_name
		  value: "uvicorn"
		- name: NODE_IP
		  valueFrom: {fieldRef: {fieldPath: status.hostIP}}
		- name: NODE_NAME
		  valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
		- name: POD_NAME
		  valueFrom: {fieldRef: {fieldPath: metadata.name}}
```

:::note

**環境変数の役割**

-   `license`：エージェント認証を確認するためのキーです。

-   `whatap_server_host`：WhaTap収集サーバーのホストIPです。

-   `app_name`: アプリケーションを識別するためのエージェント名の構成要素です。

-   `app_process_name`: アプリケーションを識別するためのエージェント名(ONAME)のコンポーネントです。アプリケーションプロセス名のアプリケーションプロセスのCPU、Heap Memoryなどを収集する対象プロセスを設定します。

-   `okind`(選択事項)：Podに該当するアプリケーションをグループ化します。 デプロイメント(Deployment) 名に設定すると、該当するPodを一つにグループ化します。

-   `NODE_IP`: 現在のPodがホストされているノード(Node)のIPアドレスを収集します。

-   `NODE_NAME`: 現在Podが実行中のノードの名前を収集します。

-   `POD_NAME`: 現在のPodの名前を収集します。



-   `whatap_micro_enabled`：コンテナとの連動を活性化します。

:::

## エージェントのインストール確認

-   エージェントが正常にインストールされたことを確認するには、***ダッシュボード*** > ***アプリケーションサービスダッシュボード***メニューに移動してください。

-   コンテナで`ps -ef | grep whatap_python`コマンドを実行し、WhaTap Pythonサービスが正常に実行されているかを確認してください。 