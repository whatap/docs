---
id: install-master-node-agent-temp-ja
title: マスターおよびNodeエージェントのインストール
description: インストール手順のページに従って、マスターおよびNodeエージェントのインストールプロセスを進めてください。
tags:
  - Kubernetes
  - Kubernetesモニタリング
  - エージェント
  - マスター
  - Node
  - エージェントのインストール
hide_table_of_contents: false
toc_max_heading_level: 2
draft: true
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

次のように、マスター及びノードエージェントのインストール過程を案内します。 ***インストール案内***画面と同じプロセスです。

:::note 

EKS Fargateは、対応予定です。 

:::

## 環境を事前に確認して設定

ユーザーのKubernetes環境によっては、事前の環境設定が必要な場合があります。 Istio、GKE、OpenShiftの環境に該当しない場合、[次の段階](#create-kubernetes-agent)に進んでください。

<Tabs>

<TabItem value='istio' label='Istio環境' default>

Istio環境の場合は、次のコマンドを実行し、WhaTap収集サーバーと通信するリソースであるServiceEntryを生成してください。

```bash title='SH'
kubectl create namespace whatap-monitoring
kubectl label namespace whatap-monitoring istio-injection=enabled
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: whatap-external
spec:
  hosts:
  - whatap-proxy1
  - whatap-proxy2
  addresses:
  - 13.124.11.223
  - 13.209.172.35
  ports:
  - name: proxy
    number: 6600
    protocol: tcp
    location: MESH_EXTERNAL
EOF
```

</TabItem>

<TabItem value='gke' label='GKE環境'>

Google Kubernetes Engine(GKE)の場合、ユーザークラスターを作成した後に権限設定をするために、次のコマンドを実行してください。

```bash
ACCOUNT=$(gcloud info --format='value(config.account)')
kubectl create clusterrolebinding owner-cluster-admin-binding \
  --clusterrole cluster-admin \
  --user $ACCOUNT
```

:::note

gcloudコマンドのインストールの詳細については、[グーグルクラウド文書](https://cloud.google.com/sdk/docs/install)を参照してください。

:::

</TabItem>

<TabItem value='openshift' label='OpenShift環境'>

![OpenShift](/img/kube-install-openshift.png)

***インストール方法***画面で***OpenShift環境の場合の追加設定***セクションを開いて***whatap_openshift_scc.yaml***ボタンを選択してください。 ファイルをダウンロードした後、次のコマンドを実行してください。

```bash
oc create -f whatap_openshift_scc.yaml
```

</TabItem>

</Tabs>

## Kubernetesエージェント作成

ユーザーのKubernetesバージョンとContainer Runtimeの*YAML*ファイルをダウンロードしてエージェントを生成してください。

1.  次のコマンドを実行し、**VERSION**と**CONTAINER-RUNTIME**を確認してください。

    ```bash
    kubectl get node -o wide
    ```

    ![](/img/k8s-check-version.svg)

2.  ***エージェントのインストール***画面で**VERSION**と**CONTAINER-RUNTIME**の*YAML*ファイルを選択し***ダウンロード***ボタンをクリックしてください。

    <ImgLang img='k8s-download-yaml.png' desc='YAMLダウンロード' />

3.  ダウンロードした*YAML*ファイルをマスターNodeにアップロードしてください。

4.  エージェントを作成するには、次のコマンドを実行してください。 

    ```bash
    # {whatap_kube_X.YZ.yaml}ファイル名をダウンロードしたファイル名と一致するように変更してください。
    kubectl apply -f {whatap_kube_X.YZ.yaml}
    ```

5.  次のようにエージェントを正常に生成(create)したことを確認してください。

    ![エージェント生成確認](/img/k8s-install-agent-check.svg)

:::note

**マスターエージェントのリソース使用量は、コンテナ数の増加によって影響を受ける可能性があります。**デフォルトで設定されたメモリlimit(350MB) を超えてリソースを使用する場合、OOM(Out Of Meomory)が発生する可能性があります。 ユーザーは、*YAML*ファイルを使用してこれらの設定を変更することができます。

:::

## Kubernetesエージェントのインストールを確認

Kubernetesエージェントのインストールが正常に完了した場合、次のコマンドを実行してマスターエージェントとノードエージェントの状態を確認することができます。

```bash
kubectl get pod -n whatap-monitoring
```

#### Running状態の場合

次のように**STATUS**項目が**Running**である場合**インストールを完了した状態**です。 マスター及びノードエージェントのインストールを完了すると、Kubernetes環境のリソースモニタリングを開始します。 [WhaTapモニタリングサービス](https://service.whatap.io)に移動し、プロジェクトリスト***とダッシュボード*** >***コンテナマップ***メニューから性能情報を収集することを確認してください。 

![](/img/k8s-check-running-agent-monitoring.svg)

#### Running状態でない場合

次のように**STATUS**項目が**Running**でない場合、インストールが正しく行われていない状態です。 

![](/img/k8s-not-running-agent-monitoring.svg)

1.  マスターNodeで次のコマンドを実行して、Pod の生成に失敗した原因を特定します。 

    ```bash
    kubectl describe pod {POD_NAME} -n whatap-monitoring
    ```

2.  実行結果の下部の**Events:**項目を確認してください。

    ![](/img/k8s-check-install-fail.svg)

:::tip

`kubectl`コマンドを使用する場合、`-n {ネームスペース}`オプションを使用して、特定のネームスペースを対象にタスクを実行します。 WhaTapエージェントは、基本的に`whatap-monitoring`というネームスペースにインストールされるため、`-n whatap-monitoring`というオプションを追加します。

:::

:::note

-   アプリケーションエージェントのインストールを進めるには、メニューの画面右下の***アプリケーションエージェントインストール***ボタンを選択してください。 詳細については、[次の文書](install-application-agent)を参照してください。
-   エージェントを最新バージョンにアップデートするには[次の文書](agent-update)を参照してください。

:::